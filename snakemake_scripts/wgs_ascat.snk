###
### COPY NUMBER USING ASCAT
###
rule alleleCount:
	input:
		bam = OUTDIR + "/Recal/{sample}.recal.bam",
		index = OUTDIR + "/Recal/{sample}.recal.bai",
		acloci = OUTDIR + "/reference/" + config["reference"]["ascat_acloci"],
		ref_fasta = OUTDIR + "/reference/" + config["reference"]["fasta"]
	output: OUTDIR + "/results/ASCAT/alleleCount/{sample}.alleleCount"
	threads: 2
	resources:
		time = "20h",
		mem_mb = 8500
	container:
		config["singularity"]["ascat"]
	shell:
		"""
		alleleCounter \
		-l {input.acloci} \
		-r {input.ref_fasta} \
		-b {input.bam} \
		-o {OUTDIR}/results/ASCAT/alleleCount/{wildcards.sample}.alleleCount
		"""

def getGender(wildcards):
		return expand("{gender}",gender = INPUT[INPUT.Patient == wildcards.patient].Sex.drop_duplicates())

###convert allele script from https://bitbucket.org/malinlarsson/somatic_wgs_pipeline/src/master/convertAlleleCounts.r
rule ConvertAlleleCounts:
	input:
		normal = OUTDIR + "/results/ASCAT/alleleCount/{patient}-N.alleleCount",
		tumor = OUTDIR + "/results/ASCAT/alleleCount/{tumor}.alleleCount",
		script = "AN_WGS_script/convertAlleleCounts.r"
	output:
		normalBaf = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{patient}-N.BAF",
		tumorBaf = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{tumor}.BAF",
		normalLogr = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{patient}-N.LogR",
		tumorLogr = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{tumor}.LogR"
	threads: 2
	params: gender = getGender
	resources:
		time = "8h",
		mem_mb = 8500
	container:
		config["singularity"]["ascat"]
	shell:
		"""
		cd {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N
		/scratch/n/nicholsa/zyfniu/AN_WGS/AN_WGS_script/convertAlleleCounts.r \
		{wildcards.tumor} {input.tumor} \
		{wildcards.patient}-N {input.normal} \
		{params.gender}
		"""

rule ascat:
	input:
		normalBaf = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{patient}-N.BAF",
		tumorBaf = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{tumor}.BAF",
		normalLogr = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{patient}-N.LogR",
		tumorLogr = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{tumor}.LogR",
		acLociGC = OUTDIR + "/reference/" + config["reference"]["ascat_acloci_gc"]
	output:
		results = OUTDIR + "/results/ASCAT/{tumor}_vs_{patient}-N/{tumor}_vs_{patient}-N.tumor.cnvs.txt"
	params:
		gender = getGender
	threads: 2
	resources:
		time = "8h",
		mem_mb = 8500
	container:
		config["singularity"]["ascat"]
	group: "ASCAT"
	shell:
		"""
		for f in {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N/*BAF \
		{OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N/*LogR; \
		do sed \'s/chr//g\' $f > {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N/tmpFile; \
		mv {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N/tmpFile $f;done
		cd {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N
		Rscript /scratch/n/nicholsa/zyfniu/AN_WGS/AN_WGS_script/run_ascat.r \
        --tumorbaf {input.tumorBaf} \
        --tumorlogr {input.tumorLogr} \
        --normalbaf {input.normalBaf} \
        --normallogr {input.normalLogr} \
        --tumorname {wildcards.tumor} \
        --basedir {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N \
        --gcfile {input.acLociGC} \
        --gender {params.gender}
		cd ../../../
		mv {OUTDIR}/results/ASCAT/{wildcards.tumor}_vs_{wildcards.patient}-N/{wildcards.tumor}.cnvs.txt {output.results}
		"""
